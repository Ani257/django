Project Tree:
=============
reverse_auction_app/
    .env
    generate_state.py
    main.py
    project_state.txt
    requirements.txt
    schema.sql
    test.html
    frontend/
        .env.local
        .gitignore
        components.json
        eslint.config.mjs
        next-env.d.ts
        next.config.ts
        package-lock.json
        package.json
        postcss.config.mjs
        README.md
        tsconfig.json
        public/
            file.svg
            globe.svg
            next.svg
            vercel.svg
            window.svg
        src/
            app/
                favicon.ico
                globals.css
                layout.tsx
                page.tsx
                login/
                    page.tsx
            components/
                AuctionCard.tsx
                FigmaUIOverlay.tsx
                Header.tsx
                Hero.tsx
                RazorpayCheckout.tsx
                ui/
                    badge.tsx
                    button.tsx
                    card.tsx
                    input.tsx
            lib/
                utils.ts
            utils/
                supabase/
                    client.ts


File: main.py
=============
import os
from fastapi import FastAPI, WebSocket, WebSocketDisconnect
from supabase import create_client, Client
import uvicorn
from dotenv import load_dotenv
from typing import Dict, List
from fastapi.middleware.cors import CORSMiddleware

app = FastAPI()

app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],  # Allows all origins
    allow_credentials=True,
    allow_methods=["*"],  # Allows all methods
    allow_headers=["*"],  # Allows all headers
)

# Initialize Supabase client
from dotenv import load_dotenv

# Ensure environment variables are loaded from the .env file in the current working directory
load_dotenv(".env")

SUPABASE_URL = os.environ.get("SUPABASE_URL", "https://your-project.supabase.co")
SUPABASE_KEY = os.environ.get("SUPABASE_KEY", "your-anon-key")

try:
    if SUPABASE_URL == "https://your-project.supabase.co":
        print("Warning: Using placeholder SUPABASE_URL")
        
    supabase: Client = create_client(SUPABASE_URL, SUPABASE_KEY)
except Exception as e:
    print(f"Error initializing Supabase client: {e}")
    supabase = None
    
class ConnectionManager:
    def __init__(self):
        # Store active connections per product: {product_id: [websocket1, websocket2, ...]}
        self.active_connections: Dict[str, List[WebSocket]] = {}

    async def connect(self, websocket: WebSocket, product_id: str):
        await websocket.accept()
        if product_id not in self.active_connections:
            self.active_connections[product_id] = []
        self.active_connections[product_id].append(websocket)

    def disconnect(self, websocket: WebSocket, product_id: str):
        if product_id in self.active_connections:
            if websocket in self.active_connections[product_id]:
                self.active_connections[product_id].remove(websocket)
            if not self.active_connections[product_id]:
                del self.active_connections[product_id]

    async def broadcast(self, message: dict, product_id: str):
        if product_id in self.active_connections:
            for connection in list(self.active_connections[product_id]):
                try:
                    await connection.send_json(message)
                except RuntimeError:
                    pass

manager = ConnectionManager()

@app.get("/")
def read_root():
    return {"message": "Welcome to the Reverse Auction API"}

@app.get("/products")
def get_products():
    if not supabase:
        return {"error": "Supabase client not initialized properly."}
    
    # Example of querying the Products table
    response = supabase.table("products").select("*").execute()
    return {"data": response.data}
    
@app.websocket("/ws/auction/{product_id}")
async def websocket_auction_endpoint(websocket: WebSocket, product_id: str):
    await manager.connect(websocket, product_id)
    try:
        while True:
            data = await websocket.receive_json()
            if data.get("action") == "share_click":
                # 1. Query current state of the product
                response = supabase.table("products").select("current_price, minimum_price, drop_time").eq("id", product_id).execute()
                
                if not response.data:
                    await websocket.send_json({"error": "Product not found"})
                    continue
                    
                product = response.data[0]
                current_price = float(product["current_price"])
                minimum_price = float(product["minimum_price"])
                
                # Check drop_time
                drop_time_str = product.get("drop_time")
                if drop_time_str:
                    from datetime import datetime, timezone
                    # Handle Supabase Z notation for UTC
                    drop_time_parsed = datetime.fromisoformat(drop_time_str.replace("Z", "+00:00"))
                    if datetime.now(timezone.utc) < drop_time_parsed:
                        await websocket.send_json({"error": "Drop has not started yet"})
                        continue
                
                # 2. Deduct price if it hasn't reached minimum
                if current_price > minimum_price:
                    new_price = max(current_price - 1.0, minimum_price) # Ensure we don't drop below minimum
                    
                    # 3. Update the new price in database
                    update_response = supabase.table("products").update({"current_price": new_price}).eq("id", product_id).execute()
                    
                    if update_response.data:
                        # 4. Broadcast the new price to all clients viewing this product
                        updated_product = update_response.data[0]
                        await manager.broadcast({
                            "type": "price_update",
                            "product_id": product_id,
                            "new_price": float(updated_product["current_price"])
                        }, product_id)
                    else:
                        await websocket.send_json({"error": "Failed to update price"})
                else:
                    await websocket.send_json({"message": "Price has reached the minimum limit."})
                    
    except WebSocketDisconnect:
        manager.disconnect(websocket, product_id)
    except Exception as e:
        print(f"WebSocket Error: {e}")
        manager.disconnect(websocket, product_id)

if __name__ == "__main__":
    uvicorn.run("main:app", host="0.0.0.0", port=8000, reload=True)


File: frontend/src/app/page.tsx
===============================
import Header from '@/components/Header';
import Hero from '@/components/Hero';
import AuctionCard from '@/components/AuctionCard';
import FigmaUIOverlay from '@/components/FigmaUIOverlay';

export default function Home() {
  return (
    <div className="min-h-screen flex flex-col bg-gray-50 font-[family-name:var(--font-geist-sans)] relative">
      <FigmaUIOverlay />

      <div className="relative z-10 flex flex-col min-h-screen">
        <Header />

        <main className="flex-1 w-full pb-20">
          <Hero />

          <section className="container max-w-screen-xl mx-auto px-4 -mt-10 sm:-mt-20 relative z-20">
            <AuctionCard />
          </section>
        </main>

        <footer className="w-full border-t border-gray-200 bg-white py-8 text-center text-sm text-gray-500">
          <p>© {new Date().getFullYear()} Drop Street. All rights reserved.</p>
        </footer>
      </div>
    </div>
  );
}


File: frontend/src/components/AuctionCard.tsx
=============================================
'use client';

import React, { useEffect, useState, useRef } from 'react';
import RazorpayCheckout from './RazorpayCheckout';
import { createClient } from '@/utils/supabase/client';
import { Button } from '@/components/ui/button';
import { ExternalLink } from 'lucide-react';

// Using the same active UUID from our database
const PRODUCT_ID = '6ca22814-c1a4-42e2-bec5-fdb388806692';

const AuctionCard = () => {
    const [price, setPrice] = useState<number | null>(null);
    const [status, setStatus] = useState<'connecting' | 'connected' | 'disconnected'>('connecting');
    const [dropTime, setDropTime] = useState<Date | null>(null);
    const [brandUrl, setBrandUrl] = useState<string | null>(null);
    const [timeRemaining, setTimeRemaining] = useState<number>(0); // Time in milliseconds

    const wsRef = useRef<WebSocket | null>(null);
    const supabase = createClient();

    // Fetch initial product data from Supabase
    useEffect(() => {
        const fetchProductData = async () => {
            const { data, error } = await supabase
                .from('products')
                .select('current_price, drop_time, brand_url')
                .eq('id', PRODUCT_ID)
                .single();

            if (error) {
                console.error("Error fetching product data:", error);
                return;
            }

            if (data) {
                setPrice(parseFloat(data.current_price));
                setBrandUrl(data.brand_url || null);
                if (data.drop_time) {
                    setDropTime(new Date(data.drop_time));
                }
            }
        };

        fetchProductData();
    }, [supabase]);

    // WebSocket logic
    useEffect(() => {
        const ws = new WebSocket(`ws://localhost:8000/ws/auction/${PRODUCT_ID}`);
        wsRef.current = ws;

        ws.onopen = () => {
            setStatus('connected');
        };

        ws.onmessage = (event) => {
            const data = JSON.parse(event.data);
            if (data.type === 'price_update') {
                setPrice(data.new_price);
            }
        };

        ws.onclose = () => {
            setStatus('disconnected');
        };

        ws.onerror = (error) => {
            console.error('WebSocket Error:', error);
            setStatus('disconnected');
        };

        return () => {
            if (wsRef.current) {
                wsRef.current.close();
            }
        };
    }, []);

    // Countdown Timer logic
    useEffect(() => {
        if (!dropTime) return;

        const calculateTimeRemaining = () => {
            const now = new Date().getTime();
            const target = dropTime.getTime();
            const difference = target - now;
            setTimeRemaining(Math.max(0, difference));
        };

        // Calculate immediately 
        calculateTimeRemaining();

        // Update every second
        const intervalId = setInterval(calculateTimeRemaining, 1000);

        return () => clearInterval(intervalId);
    }, [dropTime]);

    // Format millisecond duration to HH:MM:SS
    const formatTime = (milliseconds: number) => {
        const totalSeconds = Math.floor(milliseconds / 1000);
        const hours = Math.floor(totalSeconds / 3600);
        const minutes = Math.floor((totalSeconds % 3600) / 60);
        const seconds = totalSeconds % 60;

        return [hours, minutes, seconds]
            .map(v => v < 10 ? "0" + v : v)
            .join(":");
    };

    const handleShareClick = () => {
        // Double check not visually disabled and socket is alive
        if (timeRemaining <= 0 && wsRef.current && wsRef.current.readyState === WebSocket.OPEN) {
            wsRef.current.send(JSON.stringify({ action: 'share_click' }));
        }
    };

    const isLocked = timeRemaining > 0;

    return (
        <div className="relative group overflow-hidden rounded-3xl bg-white border border-gray-200 p-8 shadow-xl transition-all flex flex-col items-center max-w-md mx-auto w-full">
            {/* Status indicator and Verify Link Header */}
            <div className="w-full flex justify-between items-center mb-6">
                {brandUrl ? (
                    <a
                        href={brandUrl}
                        target="_blank"
                        rel="noopener noreferrer"
                        className="inline-flex items-center text-xs font-semibold text-blue-600 hover:text-blue-800 transition-colors"
                    >
                        Verify on Official Site <ExternalLink className="ml-1 w-3 h-3" />
                    </a>
                ) : (
                    <div></div> // Empty div to keep flex space-between intact
                )}

                <div className={`flex items-center gap-2 text-xs font-semibold px-2 py-1 rounded-full ${status === 'connected' ? 'text-green-700 bg-green-100' : 'text-amber-700 bg-amber-100'}`}>
                    <span className={`h-2 w-2 rounded-full ${status === 'connected' ? 'bg-green-500 animate-pulse' : 'bg-amber-500'}`}></span>
                    {status === 'connected' ? 'Live' : 'Connecting...'}
                </div>
            </div>

            {/* Hype Timer Display */}
            {dropTime && (
                <div className="mb-8 w-full">
                    <h3 className="text-center text-xs font-bold tracking-widest text-red-500 uppercase mb-2">Drop Starts In</h3>
                    <div className="text-center bg-gray-50 rounded-2xl py-4 border border-gray-100">
                        <span className="text-5xl font-black tracking-tighter tabular-nums text-gray-900">
                            {formatTime(timeRemaining)}
                        </span>
                    </div>
                </div>
            )}

            <h2 className="text-sm font-bold tracking-widest text-gray-400 uppercase mb-2">Current Price</h2>

            <div className={`text-6xl sm:text-7xl font-black tracking-tighter mb-8 tabular-nums transition-colors duration-500 ${isLocked ? 'text-gray-300' : 'text-gray-900'}`}>
                {price !== null ? `₹${price.toFixed(2)}` : '...'}
            </div>

            <Button
                onClick={handleShareClick}
                disabled={isLocked || status !== 'connected'}
                className="w-full h-16 text-lg sm:text-xl font-black relative overflow-hidden group/btn shadow-lg rounded-2xl transition-all"
            >
                <div className="absolute inset-0 bg-gradient-to-r from-red-600 to-purple-600 opacity-0 transition-opacity duration-300 group-hover/btn:opacity-20 pointer-events-none"></div>
                {isLocked ? 'LOCKED UNTIL DROP' : 'SHARE TO DROP PRICE (₹1)'}
            </Button>

            <p className="text-xs text-gray-500 mt-4 text-center font-medium">
                {isLocked ? 'Waiting for countdown to finish.' : 'Clicking reduces the price by ₹1 for EVERYONE.'}
            </p>

            <div className="w-full mt-6 pt-6 border-t border-gray-100">
                <RazorpayCheckout currentPrice={price} />
            </div>
        </div>
    );
};

export default AuctionCard;


